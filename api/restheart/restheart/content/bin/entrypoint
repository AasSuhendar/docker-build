#!/bin/bash

set -e

# Add Custom UserID as "User" User
if [ "$(id -u)" != "0" ]; then
  sed "s/^user:\(.*\):[0-9]\+:\([0-9]\+\):.*:\(.*:.*\)/user:\1:$(id -u):\2:User:\3/g" < /etc/passwd > /tmp/passwd \
  && cat /tmp/passwd > /etc/passwd \
  && rm -f /tmp/passwd
fi


# Prepare etc directory due to volume
if [ ! -d /var/www/etc ]; then
  mkdir -p /var/www/etc \
  && chown user:root /var/www/etc \
  && chmod 755 /var/www/etc \
  && cp -R /usr/local/docker/etc/* /var/www/etc/
fi


# Prepare etc/supervisor directory due to volume
if [ ! -d /var/www/etc/supervisor ]; then
  mkdir -p /var/www/etc/supervisor \
  && chown user:root /var/www/etc/supervisor \
  && chmod 755 /var/www/etc/supervisor \
  && cp -R /usr/local/docker/etc/supervisor/* /var/www/etc/supervisor/
fi
if [ ! -d /var/www/etc/supervisor/conf.d ]; then
  mkdir -p /var/www/etc/supervisor/conf.d \
  && chown user:root /var/www/etc/supervisor/conf.d \
  && chmod 755 /var/www/etc/supervisor/conf.d \
  && cp -R /usr/local/docker/etc/supervisor/conf.d/* /var/www/etc/supervisor/conf.d/
fi
if [ ! -d /var/www/etc/supervisor/log ]; then
  mkdir -p /var/www/etc/supervisor/log \
  && chown user:root /var/www/etc/supervisor/log \
  && chmod 755 /var/www/etc/supervisor/log \
  && cp -R /usr/local/docker/etc/supervisor/log/* /var/www/etc/supervisor/log/
fi


# Prepare /opt/restheart directory due to volume
if [ ! -d /opt/restheart ]; then
  mkdir -p /opt/restheart \
  && chown user:root /opt/restheart \
  && chmod 755 /opt/restheart \
  && cp -R /usr/local/docker/opt/restheart/* /opt/restheart/
fi
if [ ! -d /opt/restheart/etc ]; then
  mkdir -p /opt/restheart/etc \
  && chown user:root /opt/restheart/etc \
  && chmod 755 /opt/restheart/etc \
  && cp -R /usr/local/docker/opt/restheart/etc/* /opt/restheart/etc/
fi


# Prepare RESTHeart configuration
ARGS=${ARGS:-}
PROPS=${PROPS:-}

MONGODB_USER=${MONGODB_USER:-admin}
MONGODB_PASSWORD=${MONGODB_PASSWORD:-admin}
MONGODB_DATABASE=${MONGODB_DATABASE:-admin}
MONGODB_HOST=${MONGODB_HOST:-127.0.0.1}
MONGODB_PORT=${MONGODB_PORT:-27017}

RESTHEART_USER=${RESTHEART_USER:-admin}
RESTHEART_PASSOWRD=${RESTHEART_PASSWORD:-admin}

sed -i "s/^\(mongo-uri:\).*/\1 mongodb\:\/\/$MONGODB_USER\:$MONGODB_PASSWORD\@$MONGODB_HOST\:$MONGODB_PORT\/\?authSource\=$MONGODB_DATABASE/" /opt/restheart/etc/restheart.yml
sed -i -e "1,/    - userid:[a-zA-Z0-9]*/s/^\(    - userid:\).*/\1 $RESTHEART_USER/" /opt/restheart/etc/security.yml
sed -i -e "1,/      password:[a-zA-Z0-9]*/s/^\(      password:\).*/\1 $RESTHEART_PASSWORD/" /opt/restheart/etc/security.yml

export ARGS=$ARGS
export PROPS=$PROPS


# Execute Everything from Entries
exec "$@"
